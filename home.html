<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="node_modules/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="styles.css">

    <script>
        // JavaScript for icon hover effect
        document.addEventListener('DOMContentLoaded', () => {
            const navButtons = document.querySelectorAll('.nav-bar-titles');

            navButtons.forEach(button => {
                const icon = button.querySelector('img'); // Get the icon inside the button
                const originalSrc = icon.src; // Store the original icon source
                const hoverSrc = icon.dataset.hover; // Get the hover source from data attribute

                // Change to hover icon on mouseover
                button.addEventListener('mouseover', () => {
                    if (hoverSrc) { // Check if hoverSrc exists
                        icon.src = hoverSrc; // Change to hover icon
                    }
                });

                // Change back to original icon on mouseout
                button.addEventListener('mouseout', () => {
                    icon.src = originalSrc; // Change back to original icon
                });
            });
        });
    </script>

    <script>
        function selectButton(selectedButton, chartContainerId, loggedInfoId, titleId, containerId) {
            // Get all buttons
            const buttons = document.querySelectorAll('.logged-info-button');

            // Remove the 'selected' class from all buttons
            buttons.forEach(button => {
                button.classList.remove('selected');
                button.querySelector('.info-button-icon').classList.remove('selected');
            });

            // Add the 'selected' class to the clicked button
            selectedButton.classList.add('selected');
            selectedButton.querySelector('.info-button-icon').classList.add('selected');

            // Get all chart containers
            const chartContainers = document.querySelectorAll('.chart-container');

            // Remove the 'selected' class from all chart containers
            chartContainers.forEach(container => {
                container.classList.remove('selected');
            });

            // Add the 'selected' class to the corresponding chart container
            const selectedChartContainer = document.getElementById(chartContainerId);
            selectedChartContainer.classList.add('selected');

            // Get all logged info containers
            const loggedInfo = document.querySelectorAll('.horizontal-tile');

            // Remove the 'selected' class from all logged info containers
            loggedInfo.forEach(info => {
                info.classList.remove('selected');
            });

            // Add the 'selected' class to the corresponding logged info container
            const selectedLoggedInfo = document.getElementById(loggedInfoId);
            selectedLoggedInfo.classList.add('selected');

            // Get all title containers
            const titleList = document.querySelectorAll('.title');

            // Remove the 'selected' class from all title containers
            titleList.forEach(title => {
                title.classList.remove('selected');
            });

            // Add the 'selected' class to the corresponding title container
            const selectedTitle = document.getElementById(titleId);
            selectedTitle.classList.add('selected');

            // Get all main-container containers
            const loggedContainer = document.querySelectorAll('.main-container');

            // Remove the 'selected' class from all main-container containers
            loggedContainer.forEach(cont => {
                cont.classList.remove('selected');
            });
            console.log(loggedContainer);

            // Add the 'selected' class to the corresponding main-container container
            const selectedMainContainer = document.getElementById(containerId);
            selectedMainContainer.classList.add('selected');
        }
    </script>

    <script>
        // Function to request specific user information by userId and field
        function getUserInfo(userId, field) {
            return new Promise(function(resolve, reject) {
                // Create a new XMLHttpRequest
                var xhr = new XMLHttpRequest();
                
                // Build the URL with GET parameters (userId and field)
                var url = "readUserInfo.php?userId=" + encodeURIComponent(userId) + "&field=" + encodeURIComponent(field);
                
                // Configure the request
                xhr.open("GET", url, true);
            
                // Define what happens when the response is received
                xhr.onload = function() {
                    if (xhr.status == 200) {
                        // Parse the response (which will be the user field value)
                        var result = xhr.responseText.trim();
                        
                        // Check if the result is a valid response or error message
                        if (result !== "User not found" && result !== "Field not found") {
                            resolve(result); // Resolve the promise with the result
                        } else {
                            reject(result); // Reject the promise with the error message
                        }
                    } else {
                        reject("Error: " + xhr.status);  // Reject the promise if there's a request error
                    }
                };
            
                // Send the request
                xhr.send();
            });
        }
    </script>

    <script>
        // Function to request workout information by user_id and date
        function getWorkoutInfo(user_id, date) {
            return new Promise(function(resolve, reject) {
                // Create a new XMLHttpRequest
                var xhr = new XMLHttpRequest();
                
                // Build the URL with GET parameters (userId and field)
                var url = "readLoggedWorkouts.php?user_id=" + encodeURIComponent(user_id) + "&date=" + encodeURIComponent(date);
                
                // Configure the request
                xhr.open("GET", url, true);
            
                // Define what happens when the response is received
                xhr.onload = function() {
                    if (xhr.status == 200) {
                        // Parse the response (which will be the user field value)
                        var result = xhr.responseText.trim();
                        
                        // Check if the result is a valid response or error message
                        if (result !== "User not found" && result !== "Field not found") {
                            resolve(result); // Resolve the promise with the result
                        } else {
                            reject(result); // Reject the promise with the error message
                        }
                    } else {
                        reject("Error: " + xhr.status);  // Reject the promise if there's a request error
                    }
                };
            
                // Send the request
                xhr.send();
            });
        }
    </script>

    <script>
        // Function to request recovery information by user_id and start
        function getRecoveryInfo(user_id, start) {
            return new Promise(function(resolve, reject) {
                // Create a new XMLHttpRequest
                var xhr = new XMLHttpRequest();
                
                // Build the URL with GET parameters (userId and field)
                var url = "readLoggedRecovery.php?user_id=" + encodeURIComponent(user_id) + "&start=" + encodeURIComponent(start);
                
                // Configure the request
                xhr.open("GET", url, true);
            
                // Define what happens when the response is received
                xhr.onload = function() {
                    if (xhr.status == 200) {
                        // Parse the response (which will be the user field value)
                        var result = xhr.responseText.trim();
                        
                        // Check if the result is a valid response or error message
                        if (result !== "User not found" && result !== "Field not found") {
                            resolve(result); // Resolve the promise with the result
                        } else {
                            reject(result); // Reject the promise with the error message
                        }
                    } else {
                        reject("Error: " + xhr.status);  // Reject the promise if there's a request error
                    }
                };
            
                // Send the request
                xhr.send();
            });
        }
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body style="padding-top: 20px;">
    <div class="container">
        <!-- Calendar Header with Month name and Calendar Icon -->
        <div class="calendar-header d-flex justify-content-between align-items-center">
            <h1 class="regular" style="font-size: 24px;" id="month"></h1>
            <a href="home_alt.html"><img src="icons/calendar_icon.svg" alt="Calendar Icon" class="calendar-icon"></a>
        </div>
    
        <div class="calendar-container">
            <!-- Left Arrow -->
            <img src="icons/left_arrow.png" alt="Left Arrow" class="calendar-arrow left-arrow" id="prevWeek">
        
            <!-- Days of the week -->
            <div class="row" id="weekRow">
                <!-- Days of the current week will be dynamically inserted here -->
            </div>
        
            <!-- Right Arrow -->
            <img src="icons/right_arrow.png" alt="Right Arrow" class="calendar-arrow right-arrow" id="nextWeek">
        </div>   
        
        <div>
            <p class="regular" id='greeting' style="font-size: 16px; margin-bottom: 6px;"></p>
            <script>
                document.addEventListener('DOMContentLoaded', () => {
                    const hours = new Date().getHours();  // Get the current hour (0-23)
                    let greeting = '';

                    // Determine the greeting based on the time of day
                    if (hours < 12) {
                        greeting = 'Good Morning';
                    } else if (hours < 18) {
                        greeting = 'Good Afternoon';
                    } else {
                        greeting = 'Good Evening';
                    }

                    // Set the greeting text in the paragraph element
                    document.getElementById('greeting').textContent = greeting;
                });
            </script>

            <p class="semibold" style="font-size: 20px; margin-top: 0;" id="userIdDisplay"></p>
            <script>
                const userId = localStorage.getItem('userId');
                if (userId) {
                    getUserInfo(userId, 'FFname').then((response) => {
                        document.getElementById('userIdDisplay').innerText = response;
                    }).catch((error) => {
                        console.error(error);
                        document.getElementById('userIdDisplay').innerText = "Error fetching user info.";
                    });
                }
            </script>
        </div>

        <div class="logged-info-tile" style="position: relative;">
            <div class="chart-set">
                <div class="chart-container selected" id="A_chart">
                    <canvas id="activityChart" width="138" height="138" class="logged-info-chart"></canvas>
                    <div class="center-text logged-info-percentage" id="A_percentageText">
                        <!-- Percentage text will be set by JavaScript -->
                    </div>
                    <div class="center-text logged-info-details" id="A_detailsText">
                        <!-- Details text will be set by JavaScript -->
                    </div>
                </div>
                <div class="chart-container" id="F_chart">
                    <canvas id="foodChart" width="138" height="138" class="logged-info-chart"></canvas>
                    <div class="center-text logged-info-percentage" id="F_percentageText">
                        <!-- Percentage text will be set by JavaScript -->
                    </div>
                    <div class="center-text logged-info-details" id="F_detailsText">
                        <!-- Details text will be set by JavaScript -->
                    </div>
                </div>
                <div class="chart-container" id="R_chart">
                    <canvas id="recoveryChart" width="138" height="138" class="logged-info-chart"></canvas>
                    <div class="center-text logged-info-percentage" id="R_percentageText">
                        <!-- Percentage text will be set by JavaScript -->
                    </div>
                    <div class="center-text logged-info-details" id="R_detailsText">
                        <!-- Details text will be set by JavaScript -->
                    </div>
                </div>
            </div>

            <div class="logged-info-buttons">
                <span class="logged-info-button selected" onclick="selectButton(this, 'A_chart', 'A_logged', 'A_title', 'workouts-container')">
                    <img src="icons/flame.svg" alt="Activity Icon" class="info-button-icon selected"> Activity
                </span>
                <span class="logged-info-button" onclick="selectButton(this, 'F_chart', 'F_logged', 'F_title', 'food-container')">
                    <img src="icons/fork.knife.svg" alt="Food Icon" class="info-button-icon"> Food
                </span>
                <span class="logged-info-button" onclick="selectButton(this, 'R_chart', 'R_logged', 'R_title', 'recoveries-container')">
                    <img src="icons/lotus.svg" alt="Recovery Icon" class="info-button-icon"> Recovery
                </span>
            </div>
        </div>

        <div>
            <div class="title selected" id="A_title">Logged Activity</div>
            <div class="title" id="F_title">Logged Food</div>
            <div class="title" id="R_title">Logged Recovery</div>

            <div class="main-container selected" id="workouts-container"></div>
            <!-- script to get workouts for the current day -->
            <script>
                document.addEventListener('DOMContentLoaded', () => {
                    const today = new Date();
                    const formattedDate = today.getFullYear() + '-' 
                    + String(today.getMonth() + 1).padStart(2, '0') + '-' 
                    + String(today.getDate()).padStart(2, '0');

                    let workoutDataObject = {};

                    // Call the getUserInfo function to retrieve the data for a specific field
                    getWorkoutInfo(userId, formattedDate).then(response => {
                        // console.log("User Info for " + formattedDate + ":", response); // Log the response to the console

                        // Split the response by newlines and filter out any empty lines
                        const entries = response.split('\n').filter(entry => entry.trim() !== ''); // Remove empty lines

                        const workouts = [];
                        let currentWorkout = {};
                        let isNewWorkout = false;

                        // Process each entry line by line
                        entries.forEach(entry => {
                            const [key, value] = entry.split(':').map(str => str.trim());

                            if (key && value) {
                                if (key === 'id') {
                                    // If we find the start of a new workout (id), push the current workout if it exists
                                    if (Object.keys(currentWorkout).length > 0) {
                                        workouts.push(currentWorkout); // Save the previous workout
                                    }
                                    currentWorkout = {}; // Start a new workout object
                                    currentWorkout['id'] = value; // Add the workout id
                                } else if (key === 'Workout Title') {
                                    // If we find the workout title, finalize the current workout
                                    currentWorkout[key] = value; // Add the title
                                    workouts.push(currentWorkout); // Push this workout
                                    currentWorkout = {}; // Reset for the next workout
                                } else {
                                    // Otherwise, keep adding key-value pairs for the current workout
                                    currentWorkout[key] = String(value);
                                }
                            }
                        });

                        // Handle any potential last workout
                        if (Object.keys(currentWorkout).length > 0) {
                            workouts.push(currentWorkout);
                        }

                        // console.log(workouts); // Log all workout objects to ensure they are correctly split

                        // Check if workouts container exists
                        const workoutsContainer = document.querySelector('#workouts-container');
                        if (!workoutsContainer) {
                            console.error('Workouts container not found!');
                            return;
                        }

                        // Render each workout
                        workouts.forEach(workoutData => {
                            const workoutTitle = workoutData['Workout Title'];
                            const start = workoutData['start'];
                            const duration = workoutData['duration'];
                            const sets = workoutData['sets'];
                            const reps = workoutData['reps'];
                            const distance = workoutData['distance'];

                            // Handle HTML creation for each workout
                            const newWorkoutDiv = document.createElement('div');
                            newWorkoutDiv.classList.add('horizontal-tile', 'selected'); 
                            newWorkoutDiv.id = 'A_logged';

                            newWorkoutDiv.innerHTML = `
                                <div class="horizontal-tile-content">
                                    <div class="horizontal-tile-title-content">
                                        <span class="horizontal-tile-title">${workoutTitle || 'N/A'}</span>
                                        <span class="horizontal-tile-time">${formatTime(start)}</span>
                                    </div>
                                    <p class="horizontal-tile-descriptor">
                                        ${sets == 0 ? `Duration: ${duration || 'N/A'} minutes` : `Sets: ${sets || 'N/A'}, Reps: ${reps || 'N/A'}`}
                                        ${sets == 0 && distance ? `, Distance: ${distance || 'N/A'} miles` : ''}
                                    </p>
                                </div>
                            `;

                            workoutsContainer.appendChild(newWorkoutDiv);
                        });
                    }).catch(error => {
                        console.error("Error fetching user info:", error); // Log any errors that occur
                    });
                });

                function formatTime(timeString) {
                    // Format the time to HH:MM
                    if (!timeString) return '';
                    if (timeString.length == 2) timeString = timeString + ':00';
                    if (timeString.length == 3) timeString = timeString + '0';
                    return timeString;
                }
            </script>

            <div class="main-container" id="recoveries-container"></div>
            <script>
                document.addEventListener('DOMContentLoaded', () => {
                    const today = new Date();
                    const formattedDate = today.getFullYear() + '-' 
                    + String(today.getMonth() + 1).padStart(2, '0') + '-' 
                    + String(today.getDate()).padStart(2, '0') 
                    + ' 23:59:59'; // bogus ending time

                    let recoveryDataObject = {};

                    // Call the getRecoveryInfo function to retrieve the data for a specific field
                    getRecoveryInfo(userId, formattedDate).then(response => {
                        console.log("User Info for " + formattedDate + ":", response); // Log the response to the console

                        // Split the response by newlines and filter out any empty lines
                        const entries = response.split('\n').filter(entry => entry.trim() !== ''); // Remove empty lines

                        const recoveries = [];
                        let currentRecovery = {};
                        let isNewRecovery = false;

                        // Process each entry line by line
                        entries.forEach(entry => {
                            const [key, value] = entry.split(':').map(str => str.trim());

                            if (key && value) {
                                if (key === 'id') {
                                    // If we find the start of a new recovery (id), push the current recovery if it exists
                                    if (Object.keys(currentRecovery).length > 0) {
                                        recoveries.push(currentRecovery); // Save the previous recovery
                                    }
                                    currentRecovery = {}; // Start a new recovery object
                                    currentRecovery['id'] = value; // Add the recovery id
                                } else if (key === 'Recovery Title') {
                                    // If we find the recovery title, finalize the current recovery
                                    currentRecovery[key] = value; // Add the title
                                    recoveries.push(currentRecovery); // Push this recovery
                                    currentRecovery = {}; // Reset for the next recovery
                                } else {
                                    // Otherwise, keep adding key-value pairs for the current recovery
                                    currentRecovery[key] = String(value);
                                }
                            }
                        });

                        // Handle any potential last recovery
                        if (Object.keys(currentRecovery).length > 0) {
                            recoveries.push(currentRecovery);
                        }

                        // console.log(recoveries); // Log all recovery objects to ensure they are correctly split

                        // Check if recoveries container exists
                        const recoveriesContainer = document.querySelector('#recoveries-container');
                        if (!recoveriesContainer) {
                            console.error('Recoveries container not found!');
                            return;
                        }

                        // Render each recovery
                        recoveries.forEach(recoveryData => {
                            const recoveryTitle = recoveryData['Recovery Title'];
                            duration = recoveryData['duration'];
                            if (duration == "00") duration = "20";
                            const start = recoveryData['start'].split(' ')[1];

                            // Handle HTML creation for each recovery
                            const newRecoveryDiv = document.createElement('div');
                            newRecoveryDiv.classList.add('horizontal-tile', 'selected'); 
                            newRecoveryDiv.id = 'R_logged';

                            newRecoveryDiv.innerHTML = `
                                <div class="horizontal-tile-content">
                                    <div class="horizontal-tile-title-content">
                                        <span class="horizontal-tile-title">${recoveryTitle}</span>
                                        <span class="horizontal-tile-time">${formatTime2(start)}</span>
                                    </div>
                                    <p class="horizontal-tile-descriptor">
                                        ${`Duration: ${duration}`}
                                    </p>
                                </div>
                            `;

                            recoveriesContainer.appendChild(newRecoveryDiv);
                        });
                    }).catch(error => {
                        console.error("Error fetching recovery info:", error); // Log any errors that occur
                    });
                });

                function formatTime2(timeString) {
                    // Format the time to HH:MM
                    if (!timeString) return '';
                    if (timeString.length == 2) timeString = timeString + ':00';
                    if (timeString.length == 3) timeString = timeString + '0';
                    return timeString;
                }
            </script>


            <div class="main-container" id="food-container">
                <div class="horizontal-tile" id="F_logged">
                    <div class="horizontal-tile-content">
                        <div class="horizontal-tile-title-content">
                            <span class="horizontal-tile-title">Breakfast</span>
                            <span class="horizontal-tile-time">08:37</span>
                        </div>
                        <div class="horizontal-tile-title-content">
                            <span class="food-tile-title">Scrambled Eggs</span>
                            <span class="food-tile-title">148 cal</span>
                        </div>
                        <p class="food-tile-descriptor">2 large brown eggs</p>
                        <div class="horizontal-tile-title-content">
                            <span class="food-tile-title">Bacon</span>
                            <span class="food-tile-title">140 cal</span>
                        </div>
                        <p class="food-tile-descriptor">2 strips, Publix Brown Sugar Smoked Bacon</p>
                    </div>
                </div>
            </div>
            
        </div>
    </div>

    <script>
        const monthNames = [
            "January", "February", "March", "April", "May", "June",
            "July", "August", "September", "October", "November", "December"
        ];

        let currentDate = new Date(); // Store the current date
        let selectedDate = currentDate; // Track the selected date
        const weekRow = document.getElementById('weekRow');
        const monthHeader = document.getElementById("month");

        function updateCalendar() {
            const currentDay = currentDate.getDay();
            const currentDateNum = currentDate.getDate();
            const startOfWeek = new Date(currentDate);
            startOfWeek.setDate(currentDateNum - currentDay);

            weekRow.innerHTML = '';

            for (let i = 0; i <= 6; i++) {
                const day = new Date(startOfWeek);
                day.setDate(startOfWeek.getDate() + i);
                const dayNum = day.getDate();
                const dayName = day.toLocaleString('default', { weekday: 'narrow' });
                const isToday = day.toDateString() === new Date().toDateString();
                const isSelected = selectedDate && day.toDateString() === selectedDate.toDateString();

                const dayCol = document.createElement('div');
                dayCol.classList.add('col', 'calendar-day');
                
                if (isToday) {
                    dayCol.classList.add('current-day'); // Highlight for today
                }
                
                if (isSelected) {
                    dayCol.classList.add('selected-day'); // Highlight for selected day
                }

                dayCol.innerHTML = `<day>${dayName}</day><date>${dayNum}</date>`;

                // Add event listener for selecting a day
                dayCol.addEventListener('click', () => {
                    selectedDate = new Date(day); // Update selected date
                    updateCalendar(); // Refresh the calendar to update highlights
                });

                weekRow.appendChild(dayCol);
            }

            monthHeader.innerText = monthNames[currentDate.getMonth()];
        }


        // Event listeners for the arrows
        document.getElementById('prevWeek').addEventListener('click', () => {
            currentDate.setDate(currentDate.getDate() - 7); // Move back a week
            updateCalendar(); // Update the calendar display
        });

        document.getElementById('nextWeek').addEventListener('click', () => {
            currentDate.setDate(currentDate.getDate() + 7); // Move forward a week
            updateCalendar(); // Update the calendar display
        });

        // Initial calendar setup
        updateCalendar();
    </script>

    <nav>
        <div class="btn-group nav-bar">
            <a href="home.html" class="btn nav-bar-titles nav-bar-titles-selected">
                <img src="icons/house_filled.svg" alt="Home icon" data-hover="icons/house_filled.svg">
                Home
            </a>
            <a href="#" class="btn nav-bar-titles">
                <img src="icons/dumbell.svg" alt="Workouts icon" data-hover="icons/dumbell_filled.svg">
                Workouts
            </a>
            <a href="#" class="btn nav-bar-titles">
                <img src="icons/plus.svg" alt="Quick add icon" data-hover="icons/plus_filled.svg">
                Quick Add
            </a>
            <a href="#" class="btn nav-bar-titles">
                <img src="icons/comment.svg" alt="Community icon" data-hover="icons/comment_filled.svg">
                Community
            </a>
            <a href="#" class="btn nav-bar-titles">
                <img src="icons/profile.svg" alt="Profile icon" data-hover="icons/profile_filled.svg">
                Profile
            </a>
        </div>
    </nav>

    <!-- External JavaScript files for chart generation -->
    <script src="charts/activity_chart.js"></script>
    <!-- Inline script to pass dynamic values to the chart function -->
    <script>
        let A_goal;
        let A_current;
    
        // Using Promise.all to wait for both asynchronous calls to complete
        Promise.all([
            getUserInfo(userId, 'activity_goal').then(response => parseFloat(response)),
            getUserInfo(userId, 'activity_level').then(response => parseFloat(response))
        ]).then(([goal, current]) => {
            A_goal = goal; // Assign parsed value of 'activity_goal'
            A_current = current; // Assign parsed value of 'activity_level'
    
            // Now that the values are assigned, call the function
            updateActivityChart(A_goal, A_current);
        }).catch(error => {
            console.error("Error fetching data:", error); // Handle any errors that occur
        });
    </script>
    
    <script src="charts/food_chart.js"></script>
    <script>
        let F_goal;
        let F_current;
    
        // Using Promise.all to wait for both asynchronous calls to complete
        Promise.all([
            getUserInfo(userId, 'food_goal').then(response => parseFloat(response)),
            getUserInfo(userId, 'food_level').then(response => parseFloat(response))
        ]).then(([goal, current]) => {
            F_goal = goal; // Assign parsed value of 'activity_goal'
            F_current = current; // Assign parsed value of 'activity_level'
    
            // Now that the values are assigned, call the function
            updateFoodChart(F_goal, F_current);
        }).catch(error => {
            console.error("Error fetching data:", error); // Handle any errors that occur
        });
    </script>

    <script src="charts/recovery_chart.js"></script>
    <script>
        let R_goal;
        let R_current;
    
        // Using Promise.all to wait for both asynchronous calls to complete
        Promise.all([
            getUserInfo(userId, 'recovery_goal').then(response => parseFloat(response)),
            getUserInfo(userId, 'recovery_level').then(response => parseFloat(response))
        ]).then(([goal, current]) => {
            R_goal = goal; // Assign parsed value of 'activity_goal'
            R_current = current; // Assign parsed value of 'activity_level'
    
            // Now that the values are assigned, call the function
            updateRecoveryChart(R_goal, R_current);
        }).catch(error => {
            console.error("Error fetching data:", error); // Handle any errors that occur
        });
    </script>
    
</body>
</html>
